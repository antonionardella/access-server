# IOTA Access on STM32MP1

![drawing](/docs/images/stm32mp1.jpg)

The [STM32MP157C-DK2](https://www.st.com/en/evaluation-tools/stm32mp157c-dk2.html) Discovery Kit leverages the capabilities of STM32MP1 Series microprocessors to allow users easily develop [OpenSTLinux](https://www.st.com/en/embedded-software/stm32-mpu-openstlinux-distribution.html) applications for the ARM Dual Cortex A7 main processor, as well as STM32CubeMP1 software for the Cortex M4 coprocessor.

---

# OpenSTLinux

The IOTA Foundation and STMicroelectronics have an ongoing cooperation for the STM32Cube expansion software for the industry-leading STM32 32-bit MCU (*Cortex-M*) ecosystem, the [X-CUBE-IOTA1](https://www.st.com/en/embedded-software/x-cube-iota1.html).

While the X-CUBE-IOTA1 toolkit is useful for the M4 coprocessor, weâ€™re going to focus on the **OpenSTLinux** of the **Cortex A7**.

![drawing](/docs/images/stm32mp1_tux.jpg)

---

# PiRelay

For this guide, you should also have a [PiRelay](https://shop.sb-components.co.uk/products/pirelay-relay-board-shield-for-raspberry-pi). Since the STM32MP157C-DK2 has a Raspberry Pi compatible pinout, we should be able to use the PiRelay on the kit without problems.

![drawing](/docs/images/stm32mp1_relay.jpg)

---

# Tutorial

This tutorial assumes you have followed the [Getting Started guide for STM32MP157x-DK2](https://wiki.st.com/stm32mpu/wiki/Getting_started/STM32MP1_boards/STM32MP157x-DK2).

We assume you have:
- 1x STM32MP157x-DK2
- 1x PiRelay Raspberry Pi Shield
- 1x USB-C Cable
- 1x Power Supply
- 1x Ethernet Cable
- 1x LAN environment with DHCP
- 1x Ubuntu 18.04 host

---

## OpenSTLinux SDK

The OpenSTLinux SDK is generated as a shell script via Yocto Project's BitBake build system. We will use it to install the cross-development toolchain, which will help us **cross-compile** ASRI to the STM32MP1.

1. Create a directory for the Yocto work:
```bash
$ mkdir ${HOME}/stm32mp1
$ cd ${HOME}/stm32mp1
```

2. Clone and initialize the repositories for OpenSTLinux. We are using [Googleâ€™s repo]() tool for that:
```bash
$ repo init -u https://github.com/STMicroelectronics/oe-manifest.git -b refs/tags/openstlinux-4.19-thud-mp1-19-02-20 && repo sync
$ ls layers/
```

3. Start the build environment:
```bash
$ DISTRO=openstlinux-weston MACHINE=stm32mp1-disco source layers/meta-st/scripts/envsetup.sh
```

4. Append the following line to `conf/local.conf`:
```bash
TOOLCHAIN_HOST_TASK_remove = " nativesdk-cmake"
```

4. Populate the [Yocto SDK](https://www.yoctoproject.org/docs/current/sdk-manual/sdk-manual.html). Grab some coffee, this will take a while â˜•ðŸ•’
```bash
$ bitbake st-image-weston -c populate_sdk
```

5. Install the SDK:
```bash
$ ./tmp-glibc/deploy/sdk/st-image-weston-openstlinux-weston-stm32mp1-disco-x86_64-toolchain-2.6-snapshot.sh
```

Just use the default options that the script prompts for.

6. Load the SDK:
```bash
$ . /opt/st/stm32mp1-disco/2.6-snapshot/environment-setup-cortexa7t2hf-neon-vfpv4-openstlinux_weston-linux-gnueabi
```

## Build Access Server

You need to have followed the steps above to load the SDK to the shell environment.

1. Clone `access-server`:
```bash
$ cd ~
$ git clone https://github.com/iotaledger/access-server.git
$ cd access-Server
```

2. Initialize CMake build environment:
```bash
$ mkdir build; cd build
$ cmake .. -DCMAKE_INSTALL_PREFIX=$PWD/ext_install -AUTH_FLAVOUR=eddsa -POLICY_FORMAT=json
```

9. Cross-compile ASRI:
```bash
$ make -j8 asri
```

---

## Copy Binary

1. Connect the STM32MP157x-DK2 to the Router/Switch that gives entry to your LAN.
2. Scan the LAN for the board's IP. Here's the output of `nmap` on my setup:
```bash
$ sudo nmap -Pn 192.168.178.1/24
Nmap scan report for stm32mp1 (192.168.178.200)
Host is up (0.00065s latency).
Not shown: 999 closed ports
PORT   STATE SERVICE
22/tcp open  ssh
MAC Address: 00:80:E1:42:6B:0C (STMicroelectronics SRL)
```
3. Use [scp](https://linux.die.net/man/1/scp) to copy the binary to the board:
```bash
$ scp asri root@192.168.178.200:/home/root
```
---

## Run Access Server

1. Turn off the STM32MP157x-DK2.
2. Unscrew the LCD screen from the STM32MP157x-DK2.
3. Attach the PiRelay shield to the STM32MP157x-DK2.
4. Turn on the STM32MP157x-DK2.
4. Connect to the OpenSTLinux environment via SSH. Here's what I did on my setup:
```bash
$ ssh root@192.168.178.200
The authenticity of host 192.168.178.200 (192.168.178.200) cant be established.
RSA key fingerprint is SHA256:/p6Y1qR4p1VRDmEgwSb7ij1g1XegG6906I6N6DnkRNQ.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added '192.168.178.200' (RSA) to the list of known hosts.
root@stm32mp1:~#
```
6. Start the Access Server Reference Implementation:
```bash
$ ./asri
2020-08-29 16:04:16:  policy_loader:   INFO: [logger_init_policy_loader:42] enable logger policy_loader.
2020-08-29 16:04:16:   cclient_core:   INFO: [logger_init_client_core:16] enable logger cclient_core.
2020-08-29 16:04:16:cclient_extended:   INFO: [logger_init_client_extended:16] enable logger cclient_extended.
2020-08-29 16:04:16:         wallet:   INFO: [logger_init_wallet:42] enable logger wallet.
2020-08-29 16:04:16:         wallet:  DEBUG: [wallet_create:61] wallet initialized.
2020-08-29 16:04:16:         wallet:  DEBUG: [wallet_create:63] wallet depth: 3
2020-08-29 16:04:16:         wallet:  DEBUG: [wallet_create:65] wallet mwm: 10
2020-08-29 16:04:16:         wallet:  DEBUG: [wallet_create:67] wallet node url: nodes.comnet.thetangle.org:443
2020-08-29 16:04:16:         plugin:   INFO: [logger_init_plugin:42] enable logger plugin.
2020-08-29 16:04:16: policy_updater:   INFO: [logger_init_policy_updater:42] enable logger policy_updater.
2020-08-29 16:04:16: policy_updater:   INFO: [logger_init_policy_updater:42] enable logger policy_updater.
2020-08-29 16:04:16: access_network:   INFO: [logger_init_network:42] enable logger access_network.
2020-08-29 16:04:16:           auth:   INFO: [logger_init_auth:42] enable logger auth.
2020-08-29 16:04:16:         crypto:   INFO: [logger_init_crypto:42] enable logger crypto.
```
